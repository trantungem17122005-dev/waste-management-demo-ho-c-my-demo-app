<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Demo Ph·∫ßn m·ªÅm Qu·∫£n l√Ω R√°c Th√¥ng minh</title>
    <!-- Tailwind CSS CDN ƒë·ªÉ t·∫°o giao di·ªán ƒë·∫πp v√† responsive -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c; /* M√†u n·ªÅn t·ªëi */
            color: #e2e8f0; /* M√†u ch·ªØ s√°ng */
        }
        #map {
            height: 600px;
            width: 100%;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        /* T√πy ch·ªânh m√†u s·∫Øc cho c√°c tr·∫°ng th√°i th√πng r√°c */
        .bin-marker-full {
            background-color: #ef4444; /* M√†u ƒë·ªè cho th√πng ƒë·∫ßy */
            width: 1.5rem;
            height: 1.5rem;
            border-radius: 50%;
            border: 2px solid #fff;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
        }
        .bin-marker-normal {
            background-color: #3b82f6; /* M√†u xanh cho th√πng b√¨nh th∆∞·ªùng */
            width: 1.5rem;
            height: 1.5rem;
            border-radius: 50%;
            border: 2px solid #fff;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
        }
        .truck-marker {
            background-color: #10b981; /* M√†u xanh l√° cho xe */
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            border: 2px solid #fff;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            font-weight: bold;
            color: #fff;
        }
    </style>
    <!-- Leaflet CSS v√† JS cho b·∫£n ƒë·ªì -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha2d3-QJz1SjR-W6i3Vd9H3j9r6a3C6D3B6S8C3F6F3B6S8C3" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha2d3-WB3A2P6k7J3L4J3Z3B6S8C3F6F3B6S8C3" crossorigin=""></script>
</head>
<body class="p-6">
    <div class="container mx-auto p-4 bg-gray-800 rounded-lg shadow-xl">
        <h1 class="text-3xl font-bold text-center text-teal-400 mb-6">Ph·∫ßn m·ªÅm Qu·∫£n l√Ω Thu gom R√°c Th√¥ng minh</h1>
        
        <!-- Dashboard Th·ªëng k√™ -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
            <div class="bg-gray-900 p-4 rounded-lg shadow-md flex flex-col justify-center items-center">
                <p class="text-gray-400 text-sm">T·ªïng s·ªë th√πng r√°c</p>
                <p id="totalBins" class="text-2xl font-bold text-blue-400">0</p>
            </div>
            <div class="bg-gray-900 p-4 rounded-lg shadow-md flex flex-col justify-center items-center">
                <p class="text-gray-400 text-sm">S·ªë th√πng ƒë·∫ßy</p>
                <p id="fullBins" class="text-2xl font-bold text-red-400">0</p>
            </div>
            <div class="bg-gray-900 p-4 rounded-lg shadow-md flex flex-col justify-center items-center">
                <p class="text-gray-400 text-sm">T√¨nh tr·∫°ng xe</p>
                <p id="truckStatus" class="text-2xl font-bold text-green-400">ƒêang ch·ªù</p>
            </div>
            <div class="bg-gray-900 p-4 rounded-lg shadow-md flex flex-col justify-center items-center">
                <p class="text-gray-400 text-sm">L·ªô tr√¨nh</p>
                <p id="routeStatus" class="text-2xl font-bold text-yellow-400">Ch∆∞a c√≥</p>
            </div>
        </div>

        <!-- Khu v·ª±c B·∫£n ƒë·ªì v√† ƒêi·ªÅu khi·ªÉn -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- B·∫£n ƒë·ªì -->
            <div class="md:col-span-2">
                <div id="map"></div>
            </div>

            <!-- B·∫£ng ƒëi·ªÅu khi·ªÉn v√† Log -->
            <div class="md:col-span-1 flex flex-col bg-gray-900 p-4 rounded-lg shadow-md">
                <h3 class="text-xl font-semibold mb-4">ƒêi·ªÅu khi·ªÉn & Gi√°m s√°t</h3>
                <div class="space-y-4 mb-4">
                    <button id="startBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition duration-300 ease-in-out transform hover:scale-105">
                        B·∫Øt ƒë·∫ßu m√¥ ph·ªèng
                    </button>
                    <button id="optimizeBtn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded transition duration-300 ease-in-out transform hover:scale-105" disabled>
                        T·ªëi ∆∞u h√≥a l·ªô tr√¨nh
                    </button>
                </div>
                
                <h4 class="text-lg font-semibold mb-2">Nh·∫≠t k√Ω h·ªá th·ªëng:</h4>
                <div id="log" class="bg-gray-800 p-3 rounded-lg overflow-y-auto flex-grow h-48 border border-gray-700 text-gray-300 text-sm">
                    <!-- C√°c d√≤ng log s·∫Ω xu·∫•t hi·ªán ·ªü ƒë√¢y -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // H·∫±ng s·ªë v√† c·∫•u h√¨nh
        const FULLNESS_THRESHOLD = 80; // Ng∆∞·ª°ng ƒë·∫ßy 80%
        const SIMULATION_INTERVAL = 3000; // C·∫≠p nh·∫≠t d·ªØ li·ªáu m·ªói 3 gi√¢y

        // D·ªØ li·ªáu m√¥ ph·ªèng
        let bins = [
            { id: 1, lat: 21.028511, lng: 105.854134, fullness: 50, marker: null }, // V·ªã tr√≠ gi·∫£ ƒë·ªãnh ·ªü H√† N·ªôi
            { id: 2, lat: 21.031201, lng: 105.850422, fullness: 65, marker: null },
            { id: 3, lat: 21.034512, lng: 105.859678, fullness: 75, marker: null },
            { id: 4, lat: 21.025000, lng: 105.860100, fullness: 40, marker: null },
            { id: 5, lat: 21.022100, lng: 105.855000, fullness: 30, marker: null },
            { id: 6, lat: 21.029800, lng: 105.851000, fullness: 90, marker: null }, // Th√πng ƒë·∫ßy
            { id: 7, lat: 21.033000, lng: 105.857000, fullness: 85, marker: null }, // Th√πng ƒë·∫ßy
            { id: 8, lat: 21.027000, lng: 105.862000, fullness: 70, marker: null },
            { id: 9, lat: 21.030500, lng: 105.856500, fullness: 60, marker: null },
            { id: 10, lat: 21.026000, lng: 105.853000, fullness: 78, marker: null },
        ];
        
        let truck = { id: 'T-001', lat: 21.032, lng: 105.855, marker: null };
        let route = [];
        let simulationInterval = null;
        let isSimulating = false;
        let map;
        let routePolyline = null;
        let truckIcon;

        // L·∫•y c√°c ph·∫ßn t·ª≠ DOM
        const totalBinsEl = document.getElementById('totalBins');
        const fullBinsEl = document.getElementById('fullBins');
        const truckStatusEl = document.getElementById('truckStatus');
        const routeStatusEl = document.getElementById('routeStatus');
        const logEl = document.getElementById('log');
        const startBtn = document.getElementById('startBtn');
        const optimizeBtn = document.getElementById('optimizeBtn');

        /**
         * @desc Ghi l·∫°i th√¥ng ƒëi·ªáp v√†o log box
         * @param {string} message - N·ªôi dung th√¥ng ƒëi·ªáp
         */
        const logMessage = (message) => {
            const time = new Date().toLocaleTimeString();
            logEl.innerHTML += `<p class="text-xs text-gray-400">[${time}] ${message}</p>`;
            logEl.scrollTop = logEl.scrollHeight;
        };

        /**
         * @desc Kh·ªüi t·∫°o b·∫£n ƒë·ªì Leaflet
         */
        const initMap = () => {
            logMessage("ƒêang kh·ªüi t·∫°o b·∫£n ƒë·ªì...");
            map = L.map('map').setView([truck.lat, truck.lng], 14);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(map);

            // T·∫°o icon cho xe
            truckIcon = L.divIcon({
                className: 'truck-marker',
                html: 'üöö',
                iconSize: [32, 32],
                iconAnchor: [16, 16],
            });

            // C·∫≠p nh·∫≠t b·∫£n ƒë·ªì l·∫ßn ƒë·∫ßu
            updateMap();
        };

        /**
         * @desc C·∫≠p nh·∫≠t v·ªã tr√≠ c·ªßa c√°c th√πng r√°c v√† xe tr√™n b·∫£n ƒë·ªì
         */
        const updateMap = () => {
            // X√≥a c√°c marker c≈©
            map.eachLayer((layer) => {
                if (layer instanceof L.Marker) {
                    map.removeLayer(layer);
                }
            });

            // Th√™m c√°c marker th√πng r√°c m·ªõi
            bins.forEach(bin => {
                const markerClass = bin.fullness >= FULLNESS_THRESHOLD ? 'bin-marker-full' : 'bin-marker-normal';
                const customIcon = L.divIcon({
                    className: markerClass,
                    html: `<div class="tooltip-text" style="display:none;">Bin ${bin.id}: ${bin.fullness}% ƒë·∫ßy</div>`,
                    iconSize: [24, 24]
                });
                bin.marker = L.marker([bin.lat, bin.lng], { icon: customIcon }).addTo(map);
                bin.marker.bindPopup(`<b>Th√πng r√°c ID: ${bin.id}</b><br>M·ª©c ƒë·∫ßy: ${bin.fullness}%`).openPopup();
            });

            // Th√™m marker xe thu gom
            if (truck.marker) {
                map.removeLayer(truck.marker);
            }
            truck.marker = L.marker([truck.lat, truck.lng], { icon: truckIcon }).addTo(map);
            truck.marker.bindPopup(`<b>Xe thu gom ID: ${truck.id}</b><br>Tr·∫°ng th√°i: ${truckStatusEl.innerText}`).openPopup();

            // C·∫≠p nh·∫≠t polyline l·ªô tr√¨nh
            if (routePolyline) {
                map.removeLayer(routePolyline);
            }
            if (route.length > 0) {
                routePolyline = L.polyline(route.map(r => [r.lat, r.lng]), { color: '#3b82f6', weight: 4 }).addTo(map);
            }

            // C·∫≠p nh·∫≠t dashboard
            const fullBinsCount = bins.filter(b => b.fullness >= FULLNESS_THRESHOLD).length;
            totalBinsEl.innerText = bins.length;
            fullBinsEl.innerText = fullBinsCount;
        };

        /**
         * @desc M√¥ ph·ªèng vi·ªác thu th·∫≠p d·ªØ li·ªáu c·∫£m bi·∫øn
         */
        const updateSensorData = () => {
            if (!isSimulating) return;

            logMessage("ƒêang c·∫≠p nh·∫≠t d·ªØ li·ªáu c·∫£m bi·∫øn...");
            bins.forEach(bin => {
                // TƒÉng m·ª©c ƒë·∫ßy ng·∫´u nhi√™n, m√¥ ph·ªèng qu√° tr√¨nh s·ª≠ d·ª•ng
                bin.fullness += Math.floor(Math.random() * 10);
                if (bin.fullness > 100) bin.fullness = 100;
            });
            updateMap();
            logMessage("ƒê√£ c·∫≠p nh·∫≠t d·ªØ li·ªáu c·∫£m bi·∫øn.");
        };

        /**
         * @desc T√¨m c√°c th√πng r√°c ƒë√£ ƒë·∫ßy
         * @returns {Array} - M·∫£ng c√°c th√πng r√°c ƒë√£ ƒë·∫ßy
         */
        const findFullBins = () => {
            const fullBins = bins.filter(bin => bin.fullness >= FULLNESS_THRESHOLD);
            if (fullBins.length > 0) {
                logMessage(`T√¨m th·∫•y ${fullBins.length} th√πng r√°c ƒë√£ ƒë·∫ßy.`);
            }
            return fullBins;
        };

        /**
         * @desc T√≠nh to√°n l·ªô tr√¨nh t·ªëi ∆∞u (m√¥ ph·ªèng)
         * @param {Array} binsToCollect - M·∫£ng c√°c th√πng r√°c c·∫ßn thu gom
         */
        const calculateOptimalRoute = (binsToCollect) => {
            if (binsToCollect.length === 0) {
                logMessage("Kh√¥ng c√≥ th√πng r√°c n√†o ƒë·∫ßy, kh√¥ng c·∫ßn t·∫°o l·ªô tr√¨nh.");
                route = [];
                updateMap();
                routeStatusEl.innerText = "ƒê√£ ho√†n th√†nh";
                return;
            }

            logMessage("ƒêang t√≠nh to√°n l·ªô tr√¨nh t·ªëi ∆∞u...");
            // Thu·∫≠t to√°n ƒë∆°n gi·∫£n: s·∫Øp x·∫øp c√°c th√πng r√°c theo kho·∫£ng c√°ch t·ª´ xe
            // Note: Trong th·ª±c t·∫ø, ƒë√¢y s·∫Ω l√† m·ªôt thu·∫≠t to√°n ph·ª©c t·∫°p h∆°n nh∆∞ TSP
            binsToCollect.sort((a, b) => {
                const distA = Math.sqrt(Math.pow(a.lat - truck.lat, 2) + Math.pow(a.lng - truck.lng, 2));
                const distB = Math.sqrt(Math.pow(b.lat - truck.lat, 2) + Math.pow(b.lng - truck.lng, 2));
                return distA - distB;
            });

            // X√¢y d·ª±ng l·ªô tr√¨nh
            route = [truck, ...binsToCollect];
            logMessage(`L·ªô tr√¨nh ƒë√£ ƒë∆∞·ª£c t·∫°o v·ªõi ${binsToCollect.length} ƒëi·ªÉm d·ª´ng.`);
            routeStatusEl.innerText = "ƒê√£ c√≥ l·ªô tr√¨nh";
            truckStatusEl.innerText = "ƒêang di chuy·ªÉn";
            
            // M√¥ ph·ªèng vi·ªác xe di chuy·ªÉn theo l·ªô tr√¨nh
            simulateTruckMovement();
        };

        /**
         * @desc M√¥ ph·ªèng vi·ªác xe di chuy·ªÉn theo l·ªô tr√¨nh ƒë√£ t√≠nh to√°n
         */
        const simulateTruckMovement = () => {
            if (route.length === 0) {
                truckStatusEl.innerText = "ƒê√£ ho√†n th√†nh";
                return;
            }

            let currentBinIndex = 0;
            const moveTruck = setInterval(() => {
                const nextDestination = route[currentBinIndex];
                if (nextDestination) {
                    truck.lat = nextDestination.lat;
                    truck.lng = nextDestination.lng;
                    updateMap();
                    logMessage(`Xe ƒëang di chuy·ªÉn ƒë·∫øn th√πng r√°c ID: ${nextDestination.id || 'ƒëi·ªÉm b·∫Øt ƒë·∫ßu'}`);

                    // Khi xe ƒë·∫øn ƒëi·ªÉm d·ª´ng
                    if (Math.abs(truck.lat - nextDestination.lat) < 0.0001 && Math.abs(truck.lng - nextDestination.lng) < 0.0001) {
                        if (nextDestination.id) { // Ki·ªÉm tra ƒë√¢y l√† th√πng r√°c
                            // M√¥ ph·ªèng vi·ªác thu gom v√† reset m·ª©c ƒë·∫ßy
                            const collectedBin = bins.find(b => b.id === nextDestination.id);
                            if (collectedBin) {
                                collectedBin.fullness = 0;
                                logMessage(`ƒê√£ thu gom r√°c t·∫°i th√πng ID: ${collectedBin.id}. M·ª©c ƒë·∫ßy ƒë∆∞·ª£c reset.`);
                            }
                        }
                        currentBinIndex++;
                        if (currentBinIndex >= route.length) {
                            clearInterval(moveTruck);
                            logMessage("Xe ƒë√£ ho√†n th√†nh l·ªô tr√¨nh.");
                            truckStatusEl.innerText = "ƒê√£ ho√†n th√†nh";
                            route = [];
                            updateMap();
                        }
                    }
                }
            }, 1500);
        };

        // X·ª≠ l√Ω s·ª± ki·ªán n√∫t
        startBtn.addEventListener('click', () => {
            if (!isSimulating) {
                isSimulating = true;
                simulationInterval = setInterval(updateSensorData, SIMULATION_INTERVAL);
                startBtn.innerText = "D·ª´ng m√¥ ph·ªèng";
                startBtn.classList.remove('bg-blue-600');
                startBtn.classList.add('bg-red-600');
                optimizeBtn.disabled = false;
                logMessage("B·∫Øt ƒë·∫ßu m√¥ ph·ªèng thu th·∫≠p d·ªØ li·ªáu.");
                truckStatusEl.innerText = "ƒêang ch·ªù";
            } else {
                isSimulating = false;
                clearInterval(simulationInterval);
                startBtn.innerText = "B·∫Øt ƒë·∫ßu m√¥ ph·ªèng";
                startBtn.classList.remove('bg-red-600');
                startBtn.classList.add('bg-blue-600');
                optimizeBtn.disabled = true;
                logMessage("D·ª´ng m√¥ ph·ªèng.");
            }
        });

        optimizeBtn.addEventListener('click', () => {
            logMessage("Ng∆∞·ªùi qu·∫£n l√Ω y√™u c·∫ßu t·ªëi ∆∞u h√≥a l·ªô tr√¨nh.");
            const fullBins = findFullBins();
            calculateOptimalRoute(fullBins);
        });

        // Kh·ªüi ƒë·ªông ·ª©ng d·ª•ng khi trang ƒë∆∞·ª£c t·∫£i
        window.onload = function() {
            logMessage("Ch√†o m·ª´ng b·∫°n ƒë·∫øn v·ªõi demo. H√£y nh·∫•n 'B·∫Øt ƒë·∫ßu m√¥ ph·ªèng' ƒë·ªÉ kh·ªüi ƒë·ªông h·ªá th·ªëng.");
            initMap();
        };
    </script>
</body>
</html>
