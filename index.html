<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Demo Phần mềm Quản lý Thu gom Rác</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            /* Ensure full height on mobile devices */
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start; /* Align to top, allow content to push down */
            padding: 1rem; /* p-4, slightly less padding for mobile */
        }
        .container-wrapper {
            display: flex;
            flex-direction: column; /* Default to column for mobile */
            gap: 1.5rem; /* gap-6 */
            padding: 0; /* Remove padding here as body already has it */
            max-width: 1200px;
            width: 100%; /* Ensure it takes full width */
            margin: auto;
        }
        @media (min-width: 1024px) { /* lg breakpoint */
            .container-wrapper {
                flex-direction: row; /* Switch to row on larger screens */
            }
        }
        /* Header / View Toggles styling */
        .header-toggles {
            width: 100%;
            max-width: 4xl;
            background-color: #ffffff;
            padding: 1rem; /* p-4 */
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-lg */
            margin-bottom: 1.5rem; /* mb-6 */
            display: flex;
            justify-content: center;
            gap: 1rem; /* gap-4 */
        }
        /* Main sections styling */
        #driverApp, #dashboard {
            width: 100%; /* Take full width on mobile */
            background-color: #ffffff;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-lg */
            padding: 1.5rem; /* p-6 */
            display: flex;
            flex-direction: column;
            gap: 1.5rem; /* gap-6 */
            transform: translateY(0); /* Ensure no initial transform */
            transition: transform 0.3s ease-in-out;
        }
        @media (min-width: 1024px) {
            #driverApp, #dashboard {
                width: 50%; /* lg:w-1/2 */
            }
        }

        /* Custom scrollbar for better aesthetics */
        .overflow-y-auto::-webkit-scrollbar {
            width: 8px;
        }
        .overflow-y-auto::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .overflow-y-auto::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        .overflow-y-auto::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        canvas {
            background-color: #f8f8f8; /* Light background for the map */
            border-radius: 0.5rem; /* rounded-lg */
            display: block;
            width: 100%;
            height: 100%;
        }
        /* Ensure tables are responsive */
        .overflow-x-auto {
            -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center justify-center">

    <!-- Header / View Toggles -->
    <div class="header-toggles">
        <button id="driverAppBtn" class="px-6 py-3 rounded-lg font-semibold text-white bg-blue-600 hover:bg-blue-700 transition-colors shadow-md">
            Ứng dụng Tài xế
        </button>
        <button id="dashboardBtn" class="px-6 py-3 rounded-lg font-semibold text-gray-700 bg-gray-200 hover:bg-gray-300 transition-colors shadow-md">
            Dashboard Trung tâm
        </button>
    </div>

    <!-- Main Container Wrapper for Driver App and Dashboard -->
    <div class="container-wrapper">

        <!-- Driver App Section -->
        <div id="driverApp">
            <h2 class="text-2xl font-bold text-gray-800 text-center mb-4">Ứng dụng Tài xế</h2>

            <!-- Màn hình 1: Lộ trình hiện tại -->
            <div id="driverScreen1" class="bg-blue-50 p-6 rounded-lg shadow-inner">
                <h3 class="text-xl font-semibold text-blue-800 mb-4">Lộ trình hôm nay</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-gray-700">
                    <p><strong>Lộ trình:</strong> LT-001</p>
                    <p><strong>Xe:</strong> 29A-123.45</p>
                    <p><strong>Tài xế:</strong> Trần Tùng Em</p>
                    <p><strong>Điểm dừng còn lại:</strong> <span class="font-bold text-blue-600">5/15</span></p>
                </div>
                <!-- Canvas for Driver Map -->
                <div class="mt-6 bg-gray-200 h-48 rounded-lg flex items-center justify-center overflow-hidden">
                    <canvas id="driverMapCanvas" class="w-full h-full"></canvas>
                </div>
                <div class="mt-6">
                    <h4 class="font-semibold text-gray-800 mb-2">Danh sách điểm dừng</h4>
                    <ul class="space-y-3 overflow-y-auto max-h-60 pr-2">
                        <!-- Example Bin Item -->
                        <li class="flex items-center justify-between p-3 bg-white rounded-lg shadow-sm border border-gray-200 cursor-pointer hover:bg-gray-50 transition-colors" data-bin-id="TR-101" data-bin-status="full">
                            <div>
                                <p class="font-medium text-gray-900">Thùng rác: TR-101</p>
                                <p class="text-sm text-gray-600">123 Đường B, Phường X</p>
                            </div>
                            <span class="px-3 py-1 text-sm font-semibold rounded-full bg-red-100 text-red-800">95% Đầy</span>
                        </li>
                        <li class="flex items-center justify-between p-3 bg-white rounded-lg shadow-sm border border-gray-200 cursor-pointer hover:bg-gray-50 transition-colors" data-bin-id="TR-102" data-bin-status="near-full">
                            <div>
                                <p class="font-medium text-gray-900">Thùng rác: TR-102</p>
                                <p class="text-sm text-gray-600">456 Đường C, Phường Y</p>
                            </div>
                            <span class="px-3 py-1 text-sm font-semibold rounded-full bg-yellow-100 text-yellow-800">70% Gần đầy</span>
                        </li>
                         <li class="flex items-center justify-between p-3 bg-white rounded-lg shadow-sm border border-gray-200 cursor-pointer hover:bg-gray-50 transition-colors" data-bin-id="TR-103" data-bin-status="collected">
                            <div>
                                <p class="font-medium text-gray-900">Thùng rác: TR-103</p>
                                <p class="text-sm text-gray-600">789 Đường D, Phường Z</p>
                            </div>
                            <span class="px-3 py-1 text-sm font-semibold rounded-full bg-green-100 text-green-800">Đã thu gom</span>
                        </li>
                        <li class="flex items-center justify-between p-3 bg-white rounded-lg shadow-sm border border-gray-200 cursor-pointer hover:bg-gray-50 transition-colors" data-bin-id="TR-104" data-bin-status="full">
                            <div>
                                <p class="font-medium text-gray-900">Thùng rác: TR-104</p>
                                <p class="text-sm text-gray-600">101 Đường E, Phường A</p>
                            </div>
                            <span class="px-3 py-1 text-sm font-semibold rounded-full bg-red-100 text-red-800">90% Đầy</span>
                        </li>
                        <li class="flex items-center justify-between p-3 bg-white rounded-lg shadow-sm border border-gray-200 cursor-pointer hover:bg-gray-50 transition-colors" data-bin-id="TR-105" data-bin-status="near-full">
                            <div>
                                <p class="font-medium text-gray-900">Thùng rác: TR-105</p>
                                <p class="text-sm text-gray-600">202 Đường F, Phường B</p>
                            </div>
                            <span class="px-3 py-1 text-sm font-semibold rounded-full bg-yellow-100 text-yellow-800">65% Gần đầy</span>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Màn hình 2: Chi tiết thùng rác (ẩn ban đầu) -->
            <div id="driverScreen2" class="bg-green-50 p-6 rounded-lg shadow-inner hidden">
                <h3 class="text-xl font-semibold text-green-800 mb-4">Chi tiết thùng rác: <span id="binDetailId"></span></h3>
                <div class="grid grid-cols-1 gap-4 text-gray-700">
                    <p><strong>Địa chỉ:</strong> <span id="binDetailAddress"></span></p>
                    <p><strong>Mức đầy:</strong> <span id="binDetailLevel" class="font-bold"></span></p>
                    <p><strong>Lần thu gom gần nhất:</strong> <span id="binDetailLastCollected"></span></p>
                    <div>
                        <label for="binDetailNotes" class="block text-sm font-medium text-gray-700 mb-1">Ghi chú:</label>
                        <textarea id="binDetailNotes" rows="3" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"></textarea>
                    </div>
                </div>
                <div class="mt-6 flex flex-col sm:flex-row gap-4">
                    <button id="markCollectedBtn" class="flex-1 px-6 py-3 rounded-lg font-semibold text-white bg-green-600 hover:bg-green-700 transition-colors shadow-md">
                        Đã thu gom
                    </button>
                    <button id="reportIssueBtn" class="flex-1 px-6 py-3 rounded-lg font-semibold text-gray-700 bg-red-200 hover:bg-red-300 transition-colors shadow-md">
                        Báo cáo sự cố
                    </button>
                </div>
                <button id="backToDriverListBtn" class="mt-4 w-full px-6 py-3 rounded-lg font-semibold text-gray-700 bg-gray-200 hover:bg-gray-300 transition-colors shadow-md">
                    Quay lại danh sách
                </button>
            </div>

            <!-- Màn hình 3: Báo cáo sự cố (ẩn ban đầu) -->
            <div id="driverScreen3" class="bg-red-50 p-6 rounded-lg shadow-inner hidden">
                <h3 class="text-xl font-semibold text-red-800 mb-4">Báo cáo sự cố</h3>
                <div class="space-y-3">
                    <label class="flex items-center">
                        <input type="radio" name="issueType" value="broken" class="form-radio text-red-600">
                        <span class="ml-2 text-gray-700">Thùng rác bị hỏng</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="issueType" value="blocked" class="form-radio text-red-600">
                        <span class="ml-2 text-gray-700">Đường đi bị tắc</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="issueType" value="overflow" class="form-radio text-red-600">
                        <span class="ml-2 text-gray-700">Lượng rác quá lớn</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="issueType" value="other" class="form-radio text-red-600">
                        <span class="ml-2 text-gray-700">Lý do khác:</span>
                    </label>
                    <textarea id="otherIssueNotes" rows="3" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500 mt-2"></textarea>
                </div>
                <div class="mt-6 flex flex-col sm:flex-row gap-4">
                    <button id="submitIssueBtn" class="flex-1 px-6 py-3 rounded-lg font-semibold text-white bg-red-600 hover:bg-red-700 transition-colors shadow-md">
                        Gửi báo cáo
                    </button>
                    <button id="cancelIssueBtn" class="flex-1 px-6 py-3 rounded-lg font-semibold text-gray-700 bg-gray-200 hover:bg-gray-300 transition-colors shadow-md">
                        Hủy
                    </button>
                </div>
            </div>
        </div>

        <!-- Dashboard Section -->
        <div id="dashboard">
            <h2 class="text-2xl font-bold text-gray-800 text-center mb-4">Dashboard Trung tâm</h2>

            <!-- Màn hình 1: Tổng quan -->
            <div id="dashboardScreen1" class="bg-purple-50 p-6 rounded-lg shadow-inner">
                <h3 class="text-xl font-semibold text-purple-800 mb-4">Tổng quan hệ thống</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-4">
                    <div class="bg-white p-4 rounded-lg shadow-sm border border-purple-200">
                        <p class="text-sm text-gray-600">Tổng số thùng rác</p>
                        <p class="text-3xl font-bold text-purple-700">150</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow-sm border border-purple-200">
                        <p class="text-sm text-gray-600">Thùng cần thu gom ngay</p>
                        <p class="text-3xl font-bold text-red-600">50</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow-sm border border-purple-200">
                        <p class="text-sm text-gray-600">Xe đang hoạt động</p>
                        <p class="text-3xl font-bold text-green-600">10/12</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow-sm border border-purple-200">
                        <p class="text-sm text-gray-600">Sự cố chưa xử lý</p>
                        <p class="text-3xl font-bold text-orange-500">3</p>
                    </div>
                </div>
                <!-- Canvas for 2D Map -->
                <div class="mt-6 bg-gray-200 h-64 rounded-lg flex items-center justify-center overflow-hidden">
                    <canvas id="dashboardMapCanvas" class="w-full h-full"></canvas>
                </div>
                <button id="viewRoutesBtn" class="mt-6 w-full px-6 py-3 rounded-lg font-semibold text-white bg-purple-600 hover:bg-purple-700 transition-colors shadow-md">
                    Xem Lộ trình & Thùng rác chi tiết
                </button>
            </div>

            <!-- Màn hình 2: Quản lý Lộ trình & Thùng rác (ẩn ban đầu) -->
            <div id="dashboardScreen2" class="bg-indigo-50 p-6 rounded-lg shadow-inner hidden">
                <h3 class="text-xl font-semibold text-indigo-800 mb-4">Quản lý Lộ trình & Thùng rác</h3>

                <!-- Tabs for Routes and Bins -->
                <div class="flex border-b border-gray-200 mb-4">
                    <button id="routesTab" class="py-2 px-4 text-sm font-medium text-indigo-700 border-b-2 border-indigo-500 focus:outline-none">Lộ trình</button>
                    <button id="binsTab" class="py-2 px-4 text-sm font-medium text-gray-600 hover:text-indigo-700 hover:border-indigo-500 focus:outline-none">Thùng rác</button>
                </div>

                <!-- Routes List -->
                <div id="routesContent">
                    <h4 class="font-semibold text-gray-800 mb-2">Danh sách lộ trình</h4>
                    <div class="overflow-x-auto rounded-lg shadow-sm border border-gray-200">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mã Lộ trình</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Trạng thái</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Xe</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tài xế</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Bắt đầu</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kết thúc (DK)</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                <tr>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">LT-001</td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Đang hoạt động</span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">29A-123.45</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">Trần Tùng Em</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">08:00 AM</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">12:00 PM</td>
                                </tr>
                                <tr>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">LT-002</td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">Chờ xử lý</span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Bins List (hidden initially) -->
                <div id="binsContent" class="hidden">
                    <h4 class="font-semibold text-gray-800 mb-2">Danh sách thùng rác</h4>
                    <div class="overflow-x-auto rounded-lg shadow-sm border border-gray-200">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mã Thùng</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Địa chỉ</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mức đầy</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Trạng thái</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                <!-- Example Bin Data for Dashboard -->
                                <tr>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">TR-101</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">123 Đường B, Phường X</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">95%</td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">Đầy</span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">TR-102</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">456 Đường C, Phường Y</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">70%</td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">Gần đầy</span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">TR-103</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">20%</td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Đã thu gom</span>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <button id="backToDashboardOverviewBtn" class="mt-6 w-full px-6 py-3 rounded-lg font-semibold text-gray-700 bg-gray-200 hover:bg-gray-300 transition-colors shadow-md">
                    Quay lại Tổng quan
                </button>
            </div>
        </div>
    </div>

    <!-- Custom Message Box -->
    <div id="messageBox" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl text-center max-w-sm w-full">
            <h3 id="messageBoxTitle" class="text-xl font-bold mb-4 text-gray-800"></h3>
            <p id="messageBoxContent" class="text-gray-700 mb-6"></p>
            <button id="messageBoxCloseBtn" class="px-6 py-3 rounded-lg font-semibold text-white bg-blue-600 hover:bg-blue-700 transition-colors shadow-md">
                Đóng
            </button>
        </div>
    </div>

    <script>
        // Dummy data for demonstration
        const binsData = {
            "TR-101": { address: "Thùng rác: TR-101", level: "95% Đầy", lastCollected: "2025-08-05 10:30 AM", status: "full", x: 100, y: 80 },
            "TR-102": { address: "Thùng rác: TR-102", level: "70% Gần đầy", lastCollected: "2025-08-05 11:00 AM", status: "near-full", x: 250, y: 180 },
            "TR-103": { address: "Thùng rác: TR-103", level: "20% Đã thu gom", lastCollected: "2025-08-06 09:00 AM", status: "collected", x: 400, y: 80 },
            "TR-104": { address: "Thùng rác: TR-104", level: "90% Đầy", lastCollected: "2025-08-05 12:00 PM", status: "full", x: 150, y: 300 },
            "TR-105": { address: "Thùng rác: TR-105", level: "65% Gần đầy", lastCollected: "2025-08-05 01:00 PM", status: "near-full", x: 350, y: 250 }
        };

        const routesData = [
            ["TR-101", "TR-102", "TR-103"],
            ["TR-104", "TR-105"]
        ];

        // Dummy data for driver's current location
        const driverLocation = { x: 120, y: 120 }; // Initial driver location

        // Get elements
        const driverAppBtn = document.getElementById('driverAppBtn');
        const dashboardBtn = document.getElementById('dashboardBtn');
        const driverAppSection = document.getElementById('driverApp');
        const dashboardSection = document.getElementById('dashboard');

        // Driver App Screens
        const driverScreen1 = document.getElementById('driverScreen1');
        const driverScreen2 = document.getElementById('driverScreen2');
        const driverScreen3 = document.getElementById('driverScreen3');
        const driverMapCanvas = document.getElementById('driverMapCanvas'); // Get driver map canvas
        let driverCtx = null; // Context for drawing on driver canvas

        // Driver App Detail Elements
        const binDetailId = document.getElementById('binDetailId');
        const binDetailAddress = document.getElementById('binDetailAddress');
        const binDetailLevel = document.getElementById('binDetailLevel');
        const binDetailLastCollected = document.getElementById('binDetailLastCollected');
        const binDetailNotes = document.getElementById('binDetailNotes');

        // Driver App Buttons
        const markCollectedBtn = document.getElementById('markCollectedBtn');
        const reportIssueBtn = document.getElementById('reportIssueBtn');
        const backToDriverListBtn = document.getElementById('backToDriverListBtn');
        const submitIssueBtn = document.getElementById('submitIssueBtn');
        const cancelIssueBtn = document.getElementById('cancelIssueBtn');

        // Dashboard Screens
        const dashboardScreen1 = document.getElementById('dashboardScreen1');
        const dashboardScreen2 = document.getElementById('dashboardScreen2');
        const dashboardMapCanvas = document.getElementById('dashboardMapCanvas'); // Get dashboard map canvas
        let dashboardCtx = null; // Context for drawing on dashboard canvas

        // Dashboard Buttons
        const viewRoutesBtn = document.getElementById('viewRoutesBtn');
        const backToDashboardOverviewBtn = document.getElementById('backToDashboardOverviewBtn');
        const routesTab = document.getElementById('routesTab');
        const binsTab = document.getElementById('binsTab');
        const routesContent = document.getElementById('routesContent');
        const binsContent = document.getElementById('binsContent');

        // Message Box Elements
        const messageBox = document.getElementById('messageBox');
        const messageBoxTitle = document.getElementById('messageBoxTitle');
        const messageBoxContent = document.getElementById('messageBoxContent');
        const messageBoxCloseBtn = document.getElementById('messageBoxCloseBtn');

        let currentBinId = null; // To store the ID of the currently selected bin in driver app

        // --- Utility Functions ---

        // Function to show custom message box
        function showMessageBox(title, message) {
            messageBoxTitle.textContent = title;
            messageBoxContent.textContent = message;
            messageBox.classList.remove('hidden');
        }

        // Function to hide custom message box
        function hideMessageBox() {
            messageBox.classList.add('hidden');
        }

        // Function to draw a custom pin marker with an inner content
        function drawPinMarker(context, x, y, pinColor, contentCallback) {
            const pinWidth = 24;
            const pinHeight = 36;
            const circleRadius = 8; // Radius of the white circle inside

            context.save();
            context.translate(x, y);

            // Draw the teardrop shape
            context.beginPath();
            context.moveTo(0, -pinHeight / 2); // Top point
            context.bezierCurveTo(pinWidth / 2, -pinHeight / 2, pinWidth / 2, pinHeight / 4, 0, pinHeight / 2 - circleRadius); // Right curve
            context.bezierCurveTo(-pinWidth / 2, pinHeight / 4, -pinWidth / 2, -pinHeight / 2, 0, -pinHeight / 2); // Left curve
            context.closePath();
            context.fillStyle = pinColor;
            context.shadowColor = 'rgba(0, 0, 0, 0.3)';
            context.shadowBlur = 5;
            context.shadowOffsetY = 3;
            context.fill();
            context.shadowColor = 'transparent'; // Reset shadow

            // Draw the circle at the bottom of the teardrop
            context.beginPath();
            context.arc(0, pinHeight / 2 - circleRadius, circleRadius, 0, Math.PI * 2);
            context.fillStyle = 'white';
            context.fill();
            context.strokeStyle = pinColor;
            context.lineWidth = 2;
            context.stroke();

            // Draw content inside the white circle
            // The contentCallback will receive the context and the center of the circle (0, pinHeight/2 - circleRadius)
            // Adjust contentCallback to draw at (0,0) relative to its own translation if needed.
            context.save();
            context.translate(0, pinHeight / 2 - circleRadius); // Move origin to center of white circle
            contentCallback(context);
            context.restore();

            context.restore();
        }

        // Helper function to draw a stylized trash can icon
        function drawTrashCanShape(context) {
            const canWidth = 12;
            const canHeight = 12;
            const lidHeight = 3;

            context.fillStyle = '#666'; // Dark grey for trash can body
            context.strokeStyle = '#333';
            context.lineWidth = 1;

            // Body
            context.beginPath();
            context.rect(-canWidth / 2, -canHeight / 2 + lidHeight, canWidth, canHeight - lidHeight);
            context.fill();
            context.stroke();

            // Lid
            context.beginPath();
            context.moveTo(-canWidth / 2 - 2, -canHeight / 2 + lidHeight);
            context.lineTo(canWidth / 2 + 2, -canHeight / 2 + lidHeight);
            context.lineTo(canWidth / 2, -canHeight / 2);
            context.lineTo(-canWidth / 2, -canHeight / 2);
            context.closePath();
            context.fill();
            context.stroke();

            // Handle on lid
            context.beginPath();
            context.rect(-2, -canHeight / 2 - 2, 4, 2);
            context.fill();
            context.stroke();
        }

        // Helper function to draw a more detailed car icon inside a pin
        function drawCarShape(context) {
            const carWidth = 18; // Slightly larger
            const carHeight = 10;
            const wheelRadius = 2.5; // Slightly larger wheels

            context.fillStyle = '#333'; // Dark grey for car body
            context.strokeStyle = '#000'; // Black outline
            context.lineWidth = 1;

            // Car body
            context.beginPath();
            context.moveTo(-carWidth / 2, carHeight / 2);
            context.lineTo(carWidth / 2, carHeight / 2);
            context.lineTo(carWidth / 2, -carHeight / 2 + 2); // Back top
            context.lineTo(carWidth / 2 - 4, -carHeight / 2 - 2); // Back windshield bottom
            context.lineTo(-carWidth / 2 + 4, -carHeight / 2 - 2); // Front windshield bottom
            context.lineTo(-carWidth / 2, -carHeight / 2 + 2); // Front top
            context.closePath();
            context.fill();
            context.stroke();

            // Windows
            context.fillStyle = '#ADD8E6'; // Light blue for windows
            context.beginPath();
            // Front windshield
            context.moveTo(-carWidth / 2 + 4, -carHeight / 2 - 1.5);
            context.lineTo(carWidth / 2 - 4, -carHeight / 2 - 1.5);
            context.lineTo(carWidth / 2 - 4, -carHeight / 2 + 1);
            context.lineTo(-carWidth / 2 + 4, -carHeight / 2 + 1);
            context.closePath();
            context.fill();

            // Side window (simplified)
            context.beginPath();
            context.rect(-carWidth / 2 + 2, -carHeight / 2 + 2.5, carWidth - 4, carHeight - 5);
            context.fill();


            // Wheels
            context.fillStyle = '#000'; // Black for wheels
            context.beginPath();
            context.arc(-carWidth / 2 + wheelRadius + 2, carHeight / 2, wheelRadius, 0, Math.PI * 2);
            context.arc(carWidth / 2 - wheelRadius - 2, carHeight / 2, wheelRadius, 0, Math.PI * 2);
            context.fill();
        }


        // Function to draw a generic map (used by both driver and dashboard)
        function drawMap(canvas, context, showDriver = false) {
            if (!canvas || !context) {
                console.error("Lỗi: Canvas hoặc context không hợp lệ.");
                return;
            }

            // Set canvas dimensions to match its display size for responsiveness
            const container = canvas.parentElement;
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;

            // Clear canvas
            context.clearRect(0, 0, canvas.width, canvas.height);

            // Scale factor to fit dummy coordinates (500x350 assumed original for better detail) to current canvas size
            const originalMapWidth = 600; // Increased for more detail
            const originalMapHeight = 400; // Increased for more detail
            const scaleX = canvas.width / originalMapWidth;
            const scaleY = canvas.height / originalMapHeight;

            // --- Draw Map Background ---

            // Base map color
            context.fillStyle = '#F0F0F0'; // Light grey for general land
            context.fillRect(0, 0, canvas.width, canvas.height);

            // Green areas (parks)
            context.fillStyle = '#C8E6C9'; // Light green
            context.beginPath();
            context.moveTo(50 * scaleX, 50 * scaleY);
            context.lineTo(200 * scaleX, 50 * scaleY);
            context.lineTo(200 * scaleX, 200 * scaleY);
            context.lineTo(50 * scaleX, 200 * scaleY);
            context.closePath();
            context.fill();

            context.beginPath();
            context.arc(450 * scaleX, 100 * scaleY, 80 * scaleX, 0, Math.PI * 2); // Circular park
            context.fill();

            // Water bodies (lakes/rivers)
            context.fillStyle = '#A7D9ED'; // Light blue for water
            context.beginPath();
            context.arc(100 * scaleX, 300 * scaleY, 60 * scaleX, 0, Math.PI * 2); // Lake
            context.fill();

            context.beginPath();
            context.moveTo(350 * scaleX, 0 * scaleY);
            context.bezierCurveTo(400 * scaleX, 100 * scaleY, 300 * scaleX, 200 * scaleY, 350 * scaleX, 300 * scaleY);
            context.lineTo(360 * scaleX, 300 * scaleY);
            context.bezierCurveTo(310 * scaleX, 200 * scaleY, 410 * scaleX, 100 * scaleY, 360 * scaleX, 0 * scaleY);
            context.closePath();
            context.fill();

            // Roads
            context.strokeStyle = '#D3D3D3'; // Light grey for roads
            context.lineWidth = 12; // Thicker main roads

            // Horizontal roads
            context.beginPath();
            context.moveTo(0 * scaleX, 80 * scaleY);
            context.lineTo(canvas.width, 80 * scaleY);
            context.moveTo(0 * scaleX, 180 * scaleY);
            context.lineTo(canvas.width, 180 * scaleY);
            context.moveTo(0 * scaleX, 260 * scaleY);
            context.lineTo(canvas.width, 260 * scaleY);
            context.stroke();

            // Vertical roads
            context.beginPath();
            context.moveTo(100 * scaleX, 0 * scaleY);
            context.lineTo(100 * scaleX, canvas.height);
            context.moveTo(250 * scaleX, 0 * scaleY);
            context.lineTo(250 * scaleX, canvas.height);
            context.moveTo(400 * scaleX, 0 * scaleY);
            context.lineTo(400 * scaleX, canvas.height);
            context.stroke();

            // Add dashed lines for road lanes
            context.strokeStyle = '#FFFFFF'; // White for lane lines
            context.lineWidth = 2;
            context.setLineDash([8, 8]); // Longer dashes

            context.beginPath();
            context.moveTo(0 * scaleX, 80 * scaleY); context.lineTo(canvas.width, 80 * scaleY);
            context.moveTo(0 * scaleX, 180 * scaleY); context.lineTo(canvas.width, 180 * scaleY);
            context.moveTo(0 * scaleX, 260 * scaleY); context.lineTo(canvas.width, 260 * scaleY);

            context.moveTo(100 * scaleX, 0 * scaleY); context.lineTo(100 * scaleX, canvas.height);
            context.moveTo(250 * scaleX, 0 * scaleY); context.lineTo(250 * scaleX, canvas.height);
            context.moveTo(400 * scaleX, 0 * scaleY); context.lineTo(400 * scaleX, canvas.height);
            context.stroke();
            context.setLineDash([]); // Reset line dash

            // --- Draw Routes ---
            context.lineWidth = 3;
            context.strokeStyle = '#007bff'; // Blue for routes
            context.setLineDash([5, 5]); // Dashed line for routes
            routesData.forEach(route => {
                context.beginPath();
                route.forEach((binId, index) => {
                    const bin = binsData[binId];
                    if (bin) {
                        const x = bin.x * scaleX;
                        const y = bin.y * scaleY;
                        if (index === 0) {
                            context.moveTo(x, y);
                        } else {
                            context.lineTo(x, y);
                        }
                    }
                });
                context.stroke();
            });
            context.setLineDash([]); // Reset line dash

            // --- Draw Bins ---
            Object.values(binsData).forEach(bin => {
                const x = bin.x * scaleX;
                const y = bin.y * scaleY;
                let color;

                if (bin.status === 'full') {
                    color = '#FF0000'; // Red
                } else if (bin.status === 'near-full') {
                    color = '#FFA500'; // Orange
                } else {
                    color = '#008000'; // Green
                }
                drawPinMarker(context, x, y, color, drawTrashCanShape); // Draw trash can icon inside the pin
            });

            // --- Draw Driver's Location ---
            // This part is conditional based on the 'showDriver' parameter
            if (showDriver) {
                const driverX = driverLocation.x * scaleX;
                const driverY = driverLocation.y * scaleY;
                drawPinMarker(context, driverX, driverY, '#0000FF', drawCarShape); // Blue pin with car icon
            }
        }

        // --- Event Listeners ---

        // Toggle between Driver App and Dashboard
        if (driverAppBtn && dashboardBtn && driverAppSection && dashboardSection) {
            driverAppBtn.addEventListener('click', () => {
                driverAppSection.classList.remove('hidden');
                dashboardSection.classList.add('hidden');
                driverAppBtn.classList.add('bg-blue-600', 'text-white');
                driverAppBtn.classList.remove('bg-gray-200', 'text-gray-700');
                dashboardBtn.classList.add('bg-gray-200', 'text-gray-700');
                dashboardBtn.classList.remove('bg-blue-600', 'text-white');
                // Draw driver map when driver app is shown
                if (!driverCtx) {
                    driverCtx = driverMapCanvas.getContext('2d');
                }
                drawMap(driverMapCanvas, driverCtx, true); // Show driver on driver map
            });

            dashboardBtn.addEventListener('click', () => {
                dashboardSection.classList.remove('hidden');
                driverAppSection.classList.add('hidden');
                dashboardBtn.classList.add('bg-blue-600', 'text-white');
                dashboardBtn.classList.remove('bg-gray-200', 'text-gray-700');
                driverAppBtn.classList.add('bg-gray-200', 'text-gray-700');
                driverAppBtn.classList.remove('bg-blue-600', 'text-white');
                // Draw dashboard map when dashboard is shown
                if (!dashboardCtx) {
                    dashboardCtx = dashboardMapCanvas.getContext('2d');
                }
                drawMap(dashboardMapCanvas, dashboardCtx, false); // DO NOT show driver on dashboard map
            });
        } else {
            console.error("Lỗi: Không tìm thấy một hoặc nhiều phần tử nút chuyển đổi hoặc các phần chính của ứng dụng.");
        }


        // Driver App: Handle clicking on a bin item to show details
        document.querySelectorAll('#driverScreen1 ul li').forEach(item => {
            item.addEventListener('click', () => {
                currentBinId = item.dataset.binId;
                const binInfo = binsData[currentBinId];

                if (binInfo) {
                    binDetailId.textContent = currentBinId;
                    binDetailAddress.textContent = binInfo.address;
                    binDetailLevel.textContent = binInfo.level;
                    binDetailLastCollected.textContent = binInfo.lastCollected;
                    binDetailNotes.value = ''; // Clear notes when opening
                    driverScreen1.classList.add('hidden');
                    driverScreen2.classList.remove('hidden');
                }
            });
        });

        // Driver App: Mark as Collected button
        if (markCollectedBtn) {
            markCollectedBtn.addEventListener('click', () => {
                if (currentBinId) {
                    // Simulate updating status in dummy data
                    binsData[currentBinId].status = "collected";
                    binsData[currentBinId].level = "20% Đã thu gom";
                    binsData[currentBinId].lastCollected = new Date().toLocaleString('vi-VN');

                    // Update UI for the collected bin in the list
                    const collectedBinElement = document.querySelector(`#driverScreen1 ul li[data-bin-id="${currentBinId}"]`);
                    if (collectedBinElement) {
                        collectedBinElement.dataset.binStatus = "collected";
                        const statusSpan = collectedBinElement.querySelector('span');
                        statusSpan.textContent = "Đã thu gom";
                        statusSpan.classList.remove('bg-red-100', 'text-red-800', 'bg-yellow-100', 'text-yellow-800');
                        statusSpan.classList.add('bg-green-100', 'text-green-800');
                    }

                    showMessageBox('Thành công', `Thùng rác ${currentBinId} đã được đánh dấu là đã thu gom.`);
                    driverScreen2.classList.add('hidden');
                    driverScreen1.classList.remove('hidden');
                    // Redraw both maps if status changes
                    if (!driverCtx) { driverCtx = driverMapCanvas.getContext('2d'); }
                    drawMap(driverMapCanvas, driverCtx, true);
                    if (!dashboardCtx) { dashboardCtx = dashboardMapCanvas.getContext('2d'); }
                    drawMap(dashboardMapCanvas, dashboardCtx, false); // Redraw dashboard without driver
                }
            });
        } else {
            console.error("Lỗi: Không tìm thấy nút 'Đã thu gom'.");
        }


        // Driver App: Report Issue button
        if (reportIssueBtn) {
            reportIssueBtn.addEventListener('click', () => {
                driverScreen2.classList.add('hidden');
                driverScreen3.classList.remove('hidden');
            });
        } else {
            console.error("Lỗi: Không tìm thấy nút 'Báo cáo sự cố'.");
        }


        // Driver App: Back to list button from detail screen
        if (backToDriverListBtn) {
            backToDriverListBtn.addEventListener('click', () => {
                driverScreen2.classList.add('hidden');
                driverScreen1.classList.remove('hidden');
            });
        } else {
            console.error("Lỗi: Không tìm thấy nút 'Quay lại danh sách' (từ chi tiết thùng rác).");
        }


        // Driver App: Submit Issue button
        if (submitIssueBtn) {
            submitIssueBtn.addEventListener('click', () => {
                const selectedIssue = document.querySelector('input[name="issueType"]:checked');
                const otherNotes = document.getElementById('otherIssueNotes').value;
                let issueDescription = '';

                if (selectedIssue) {
                    issueDescription = selectedIssue.value;
                    if (issueDescription === 'other' && otherNotes) {
                        issueDescription = `Lý do khác: ${otherNotes}`;
                    } else if (issueDescription === 'broken') {
                        issueDescription = 'Thùng rác bị hỏng';
                    } else if (issueDescription === 'blocked') {
                        issueDescription = 'Đường đi bị tắc';
                    } else if (issueDescription === 'overflow') {
                        issueDescription = 'Lượng rác quá lớn';
                    }
                } else if (otherNotes) {
                    issueDescription = `Lý do khác: ${otherNotes}`;
                } else {
                    showMessageBox('Lỗi', 'Vui lòng chọn loại sự cố hoặc nhập ghi chú.');
                    return;
                }

                showMessageBox('Báo cáo đã gửi', `Đã gửi báo cáo sự cố cho thùng rác ${currentBinId}: ${issueDescription}`);
                driverScreen3.classList.add('hidden');
                driverScreen1.classList.remove('hidden');
            });
        } else {
            console.error("Lỗi: Không tìm thấy nút 'Gửi báo cáo'.");
        }


        // Driver App: Cancel Issue button
        if (cancelIssueBtn) {
            cancelIssueBtn.addEventListener('click', () => {
                driverScreen3.classList.add('hidden');
                driverScreen2.classList.remove('hidden'); // Go back to bin detail
            });
        } else {
            console.error("Lỗi: Không tìm thấy nút 'Hủy' (báo cáo sự cố).");
        }


        // Message Box Close Button
        if (messageBoxCloseBtn) {
            messageBoxCloseBtn.addEventListener('click', hideMessageBox);
        } else {
            console.error("Lỗi: Không tìm thấy nút đóng hộp thoại thông báo.");
        }


        // Dashboard: View Routes & Bins button
        if (viewRoutesBtn && dashboardScreen1 && dashboardScreen2 && routesTab) {
            viewRoutesBtn.addEventListener('click', () => {
                dashboardScreen1.classList.add('hidden');
                dashboardScreen2.classList.remove('hidden');
                // Ensure Routes tab is active by default
                routesTab.click();
            });
        } else {
            console.error("Lỗi: Không tìm thấy một hoặc nhiều phần tử nút xem lộ trình hoặc các màn hình dashboard.");
        }


        // Dashboard: Back to Overview button
        if (backToDashboardOverviewBtn && dashboardScreen2 && dashboardScreen1) {
            backToDashboardOverviewBtn.addEventListener('click', () => {
                dashboardScreen2.classList.add('hidden');
                dashboardScreen1.classList.remove('hidden');
            });
        } else {
            console.error("Lỗi: Không tìm thấy nút quay lại tổng quan hoặc các màn hình dashboard.");
        }


        // Dashboard: Tab switching for Routes and Bins
        if (routesTab && binsTab && routesContent && binsContent) {
            routesTab.addEventListener('click', () => {
                routesTab.classList.add('border-indigo-500', 'text-indigo-700');
                routesTab.classList.remove('border-transparent', 'text-gray-600', 'hover:text-indigo-700');
                binsTab.classList.add('border-transparent', 'text-gray-600', 'hover:text-indigo-700');
                binsTab.classList.remove('border-indigo-500', 'text-indigo-700');
                routesContent.classList.remove('hidden');
                binsContent.classList.add('hidden');
            });

            binsTab.addEventListener('click', () => {
                binsTab.classList.add('border-indigo-500', 'text-indigo-700');
                binsTab.classList.remove('border-transparent', 'text-gray-600', 'hover:text-indigo-700');
                routesTab.classList.add('border-transparent', 'text-gray-600', 'hover:text-indigo-700');
                routesTab.classList.remove('border-indigo-500', 'text-indigo-700');
                binsContent.classList.remove('hidden');
                routesContent.classList.add('hidden');
            });
        } else {
            console.error("Lỗi: Không tìm thấy một hoặc nhiều phần tử tab hoặc nội dung tab.");
        }


        // Initial state: Show Driver App by default and draw its map
        document.addEventListener('DOMContentLoaded', () => {
            if (driverAppSection && dashboardSection && driverAppBtn && dashboardBtn) {
                driverAppSection.classList.remove('hidden');
                dashboardSection.classList.add('hidden');
                driverAppBtn.classList.add('bg-blue-600', 'text-white');
                driverAppBtn.classList.remove('bg-gray-200', 'text-gray-700');
                dashboardBtn.classList.add('bg-gray-200', 'text-gray-700');
                dashboardBtn.classList.remove('bg-blue-600', 'text-white');

                // Initialize and draw driver map on load
                if (driverMapCanvas) {
                    driverCtx = driverMapCanvas.getContext('2d');
                    drawMap(driverMapCanvas, driverCtx, true);
                }
            } else {
                console.error("Lỗi: Không tìm thấy một hoặc nhiều phần tử cần thiết để thiết lập trạng thái ban đầu (driverAppSection, dashboardSection, driverAppBtn, dashboardBtn).");
            }
        });

        // Add event listener for window resize to redraw the map
        window.addEventListener('resize', () => {
            // Only redraw if the dashboard is currently visible
            if (!dashboardSection.classList.contains('hidden')) {
                if (!dashboardCtx) { dashboardCtx = dashboardMapCanvas.getContext('2d'); }
                drawMap(dashboardMapCanvas, dashboardCtx, false); // Redraw dashboard without driver
            } else if (!driverAppSection.classList.contains('hidden')) {
                if (!driverCtx) { driverCtx = driverMapCanvas.getContext('2d'); }
                drawMap(driverMapCanvas, driverCtx, true); // Redraw driver map with driver
            }
        });

    </script>
</body>
</html>

